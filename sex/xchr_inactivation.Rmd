---
title: "X chromosome inactivation"
---

```{r echo=FALSE, include=FALSE}
library(scater)
library(ggpubr)
```

```{r define_opts, echo=FALSE, include=FALSE}
if (grepl("ricard",Sys.info()['nodename'])) {
  source("/Users/ricard/10x_gastrulation_DNMTs/settings.R")
} else {
  stop("Computer not recognised")
}
io$outdir <- paste0(io$basedir,"/results/xchr_inactivation")
```

Define options
```{r}
opts$batches <- c(
  "SIGAA6_E85_2_Dnmt3aKO_Dnmt3b_WT_L001", 
  "SIGAB6_E85_3_Dnmt3aWT_Dnmt3b_WT_L002", 
  "SIGAC6_E85_5_Dnmt3aKO_Dnmt3b_Het_L003", 
  "SIGAD6_E85_8_Dnmt3aHet_Dnmt3b_KO_L004",
  "15_E8_5_D3A_WT_D3B_WT_L007",
  "17_E8_5_D3A_KO_D3B_WT_L008",
  "2_E8_5_D3A_WT_D3B_KO_L003",
  "3_E8_5_D3A_HET_D3B_WT_L004",
  "7_E8_5_D3A_WT_D3B_KO_L005",
  "8_E8_5_D3A_KO_D3B_KO_L006"
  
  # "E125_DNMT3A_HET_A_L001", 
  # "E125_DNMT3A_HET_A_L003", 
  # "E125_DNMT3A_KO_B_L002", 
  # "E125_DNMT3A_KO_E_L004", 
  # "A_E12_5_D3a_Het_L001",
  # "B_E12_5_D3a_KO_L002"
)
```

Update sample metadata
```{r}
sample_metadata <- sample_metadata[batch%in%opts$batches]
```

# Load data

Load SingleCellExperiment
```{r load_expr, echo=FALSE, include=FALSE}
sce <- readRDS(io$sce)[,sample_metadata$cell]
```

Load sex information
```{r}
sex.dt <- fread(io$sex)
female.embryos <- sex.dt[sex=="female",batch]
```

Load gene metadata
```{r}
gene_metadata <- fread(io$gene_metadata) %>% 
  .[ens_id%in%rownames(sce)]
```

# Parse data

Group genes by chromosome
```{r}
genes.chrY <- gene_metadata[chr=="chrY",ens_id]
genes.chrX <- gene_metadata[chr=="chrX",ens_id]
genes.chr10 <- gene_metadata[chr=="chr10",ens_id]
```

Create data.table from SingleCellExperiment object
```{r}
dt <- counts(sce[c(genes.chrX,genes.chr10),]) %>% as.matrix %>% t %>%
  as.data.table(keep.rownames="cell") %>%
  melt(id.vars="cell", value.name="counts", variable.name="ens_id") %>%
  merge(sample_metadata[,c("cell","batch","class","celltype.mapped")], by="cell")  %>%
  merge(gene_metadata[,c("chr","ens_id","symbol")], by="ens_id")
```

```{r}
# dt <- opts$batches %>% map(function(i) { 
#   sce.filt <- sce[,sce$batch==i] %>% .[c(genes.chrY,genes.chrX,genes.chr10),]
#   dt <- data.table(
#     ens_id = rownames(sce.filt),
#     counts = counts(sce.filt) %>% Matrix::rowSums()
#   ) %>% .[,batch:=i] %>% merge(sample_metadata[,c("cell","celltype.mapped")],by=c("cell","batch"))
# }) %>% rbindlist %>% merge(gene_metadata[,c("chr","ens_id","symbol")], by="ens_id")
```

# Plot

## Xist expression per embryo and lineage

```{r}
to.plot <- dt %>% .[ens_id%in%"ENSMUSG00000086503"] %>% .[batch%in%female.embryos] %>%
  .[,.(counts=mean(counts)),by=c("batch","ens_id","celltype.mapped")]
```

```{r}
p <- ggbarplot(to.plot, x="celltype.mapped", y="counts", fill="celltype.mapped") +
  facet_wrap(~batch) +
  scale_fill_manual(values=opts$celltype.colors) +
  labs(x="", y="Average Xist counts") +
  theme(
    legend.position = "none",
    # axis.text.x = element_text(colour="black",size=rel(0.8), angle=45, hjust=1, vjust=1),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )

# pdf(sprintf("%s/pdf/sex_ychr_expr_aggregated.pdf",io$outdir), width=8, height=6, useDingbats = F)
print(p)
# dev.off()
```

## Plot chrX/chr10 ratio per embryo and lineage

```{r}
to.plot <- dt %>% 
  # merge(sample_metadata[,c("cell","celltype.mapped")], by="cell") %>%
  .[,.(counts=sum(counts)),by=c("batch","chr","celltype.mapped")] %>%
  dcast(batch+celltype.mapped~chr, value.var="counts") %>%
  .[,ratioX:=chrX/chr10]
```

Barplots of chrX/chr10 count ratio per batch and lineage
```{r}
p <- ggbarplot(to.plot, x="celltype.mapped", y="ratioX", fill="celltype.mapped") +
  facet_wrap(~batch) +
  scale_fill_manual(values=opts$celltype.colors) +
  labs(x="", y="chrX/chr10 counts ratio") +
  theme(
    legend.position = "none",
    # axis.text.x = element_text(colour="black",size=rel(0.8), angle=45, hjust=1, vjust=1),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )

# pdf(sprintf("%s/pdf/sex_ychr_expr_aggregated.pdf",io$outdir), width=8, height=6, useDingbats = F)
print(p)
# dev.off()
```
